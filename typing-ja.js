"use strict";var _slicedToArray=function(){return function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var n=[],a=!0,r=!1,i=void 0;try{for(var u,o=e[Symbol.iterator]();!(a=(u=o.next()).done)&&(n.push(u.value),!t||n.length!==t);a=!0);}catch(e){r=!0,i=e}finally{try{!a&&o.return&&o.return()}finally{if(r)throw i}}return n}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}();function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var am=require("dfa.js"),StateNumSequence=am.StateNumSequence,State=am.State,Fragment=am.Fragment,NFA=am.NFA,CharInput=am.CharInput,Sentence=function(){function e(t){var n=this;if(_classCallCheck(this,e),null===t||void 0===t)throw"Parameter 'text' is required";this.text=t;return this.kanas=Object.freeze(function e(t){var a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;switch(t.length){case 0:return[];default:var r=function(e,t){if(e.length>1){var a=e.slice(-2);if(Kana.mapping[a])return[new Kana.Double(n,a),e.slice(0,-2)]}var r=e.slice(-1),i=e.slice(0,-1);switch(r){case"ッ":return[new Kana.Ltu(n,t),i];case"ン":return[new Kana.N(n,t),i];default:return[new Kana.Single(n,r),i]}}(t,a),i=_slicedToArray(r,2),u=i[0];return e(i[1],u).concat(u)}}(t)),Object.freeze(this)}return _createClass(e,[{key:"newChallenge",value:function(){return new Challenge(this)}},{key:"getDefaultRoman",value:function(){return this.kanas.reduce(function(e,t){return e+t.getDefaultRoman()},"")}},{key:"getDefaultRomanAfter",value:function(e){return this.kanas.slice(this.kanas.indexOf(e)+1).reduce(function(e,t){return e+t.getDefaultRoman()},"")}},{key:"getKanaIterator",value:function(){return new KanaIterator(this)}},{key:"getDFA",value:function(){var e=Fragment.concatAll(this.kanas.map(function(e){return e.getNFAFragment()})).toUnacceptable().toLastAcceptable(),t=new NFA;return t.addStartState(new State(StateNumSequence.newSequence().next(),[])),t.appendFragment(e,t.start.num),t.toDFA()}}]),e}(),KanaIterator=function(){function e(t){_classCallCheck(this,e),this._sentence=t,this._index=0}return _createClass(e,[{key:"next",value:function(){if(!this.hasNext())throw"No more kana in the sentence";return this._sentence.kanas[this._index++]}},{key:"hasNext",value:function(){return this._index<this._sentence.kanas.length}}]),e}();Sentence.test=function(e){var t=new Sentence(e);return[t.getDefaultRoman()].concat(t.kanas.map(function(e){return e.getDefaultRomanAfterThis()}))};var Kana=function(){function e(t){_classCallCheck(this,e),this.sentence=t}return _createClass(e,[{key:"getDefaultRoman",value:function(){throw"unsupported operation"}},{key:"getDefaultRomanAfterThis",value:function(){return this.sentence.getDefaultRomanAfter(this)}},{key:"getNFAFragment",value:function(){throw"getNFAFragment() must be implemented by subclasses."}},{key:"getDFA",value:function(){var e=new NFA;return e.addStartState(new State(StateNumSequence.newSequence().next(),[])),e.appendFragment(this.getNFAFragment(),e.start.num),e.toDFA()}}],[{key:"tails",value:function(e){return function e(t){switch(t.length){case 0:return[];default:return[t].concat(e(t.slice(1)))}}(e)}},{key:"romanToFragment",value:function(t){var n=StateNumSequence.newSequence(),a=new State(n.next(),[]).toAcceptable(t),r=e.tails(t).reduce(function(e,t){var r=new am.Edge(new am.CharLabel.Single(t.charAt(0)),a.num),i=new State(n.next(),[r],{tail:t});if(e.length>0){var u=e[e.length-1];e[e.length-1]=u.changeEdgesDest(a.num,i.num)}return e.concat(i)},[]);return new Fragment(r.concat(a))}}]),e}();Kana.Single=function(e){function t(e,n){_classCallCheck(this,t);var a=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return a.ch=n,a.romans=Object.freeze(Kana.mapping[n]),_possibleConstructorReturn(a,Object.freeze(a))}return _inherits(t,Kana),_createClass(t,[{key:"getDefaultRoman",value:function(){return this.romans[0]}},{key:"getNFAFragment",value:function(){var e=this.romans.map(function(e){return Kana.romanToFragment(e)});return Fragment.mergeAll(e)}}]),t}(),Kana.Double=function(e){function t(e,n){_classCallCheck(this,t);var a=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return a.chs=n,a.romans=Kana.mapping[n],a}return _inherits(t,Kana),_createClass(t,[{key:"getDefaultRoman",value:function(){return this.romans[0]}},{key:"getNFAFragment",value:function(){var e=this.romans.map(function(e){return Kana.romanToFragment(e)}),t=Fragment.mergeAll(Kana.mapping[this.chs[1]].map(function(e){return Kana.romanToFragment(e)})),n=Kana.mapping[this.chs[0]].map(function(e){return Kana.romanToFragment(e).concat(t)});return Fragment.mergeAll(e.concat(n)).toUnacceptable().toLastAcceptable()}}]),t}(),Kana.Ltu=function(e){function t(e,n){_classCallCheck(this,t);var a=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return a.prev=n,a.romans=Object.freeze(["ltu","xtu","ltsu","xtsu"]),_possibleConstructorReturn(a,Object.freeze(a))}return _inherits(t,Kana),_createClass(t,[{key:"getDefaultRoman",value:function(){if(this.prev){var e=this.prev.getDefaultRoman().charAt(0);if(!"aiueon".includes(e))return e}return this.romans[0]}},{key:"getNFAFragment",value:function(){var e=[];if(this.prev){var t=this.prev.getDefaultRoman().charAt(0);"aiueon".includes(t)||e.push(Kana.romanToFragment(t))}return Fragment.mergeAll(e.concat(this.romans.map(function(e){return Kana.romanToFragment(e)})))}}]),t}(),Kana.N=function(e){function t(e,n){_classCallCheck(this,t);var a=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return a.prev=n,a.allowSingleN=n&&!"aiueony".includes(n.getDefaultRoman().charAt(0)),_possibleConstructorReturn(a,Object.freeze(a))}return _inherits(t,Kana),_createClass(t,[{key:"getDefaultRoman",value:function(){return this.allowSingleN?"n":"nn"}},{key:"getNFAFragment",value:function(){return this.allowSingleN?Fragment.mergeAll(["n","nn"].map(function(e){return Kana.romanToFragment(e)})).toUnacceptable().toLastAcceptable():Kana.romanToFragment("nn")}}]),t}();var Challenge=function(){function e(t){_classCallCheck(this,e),this._sentence=t,this._transitions=t.kanas.map(function(e){return e.getDFA().startNewTransition()}),this._pointer=0,this._typedRoman=[],this._typingCount=0,this._mistypingCount=0}return _createClass(e,[{key:"input",value:function(e){if(this.isCleared())throw"Challenge has been cleared";var t=new CharInput(e);if(this._currentTransition.move(t))return this._typedRoman.push(e),this._typingCount++,!0;var n=this._transitions[this._pointer+1];return this._currentTransition.isAcceptable()&&n&&n.move(t)?(this._typedRoman.push(e),this._typingCount++,this._pointer++,!0):(this._mistypingCount++,!1)}},{key:"isCleared",value:function(){return this._transitions[this._transitions.length-1].isAcceptable()}},{key:"text",get:function(){return this._sentence.text}},{key:"roman",get:function(){return this._sentence.getDefaultRoman()}},{key:"typedRoman",get:function(){return this._typedRoman.join("")}},{key:"remainingRoman",get:function(){if(this.isCleared())return"";var e=this._currentTransition.current.attrs.tail;return(!this._currentTransition.isAcceptable()&&e&&e.length>0?e[0]:"")+this._sentence.getDefaultRomanAfter(this._currentKana)}},{key:"typingCount",get:function(){return this._typingCount}},{key:"mistypingCount",get:function(){return this._mistypingCount}},{key:"_currentTransition",get:function(){return this._transitions[this._pointer]}},{key:"_currentKana",get:function(){return this._sentence.kanas[this._pointer]}}]),e}();Kana.DEFAULT_KANA_MAPPING=Object.freeze({"ア":["a"],"イ":["i"],"ウ":["u","wu","whu"],"エ":["e"],"オ":["o"],"カ":["ka","ca"],"キ":["ki"],"ク":["ku","cu","qu"],"ケ":["ke"],"コ":["ko","co"],"サ":["sa"],"シ":["si","shi","ci"],"ス":["su"],"セ":["se","ce"],"ソ":["so"],"タ":["ta"],"チ":["ti","chi"],"ツ":["tu","tsu"],"テ":["te"],"ト":["to"],"ナ":["na"],"ニ":["ni"],"ヌ":["nu"],"ネ":["ne"],"ノ":["no"],"ハ":["ha"],"ヒ":["hi"],"フ":["hu","fu"],"ヘ":["he"],"ホ":["ho"],"マ":["ma"],"ミ":["mi"],"ム":["mu"],"メ":["me"],"モ":["mo"],"ヤ":["ya"],"ユ":["yu"],"ヨ":["yo"],"ラ":["ra"],"リ":["ri"],"ル":["ru"],"レ":["re"],"ロ":["ro"],"ワ":["wa"],"ヲ":["wo"],"ガ":["ga"],"ギ":["gi"],"グ":["gu"],"ゲ":["ge"],"ゴ":["go"],"ザ":["za"],"ジ":["zi","ji"],"ズ":["zu"],"ゼ":["ze"],"ゾ":["zo"],"ダ":["da"],"ヂ":["di"],"ヅ":["du"],"デ":["de"],"ド":["do"],"バ":["ba"],"ビ":["bi"],"ブ":["bu"],"ベ":["be"],"ボ":["bo"],"パ":["pa"],"ピ":["pi"],"プ":["pu"],"ペ":["pe"],"ポ":["po"],"ヴ":["vu"],"ー":["-"],"ァ":["la","xa"],"ィ":["li","xi","lyi","xyi"],"ゥ":["lu","xu"],"ェ":["le","xe","lye","xye"],"ォ":["lo","xo"],"ヵ":["lka","xka"],"ヶ":["lke","xke"],"ヮ":["lwa","xwa"],"ャ":["lya","xya"],"ュ":["lyu","xyu"],"ョ":["lyo","xyo"],"キャ":["kya"],"キィ":["kyi"],"キュ":["kyu"],"キェ":["kye"],"キョ":["kyo"],"シャ":["sya","sha"],"シィ":["syi"],"シュ":["syu","shu"],"シェ":["sye","she"],"ショ":["syo","sho"],"チャ":["tya","cha","cya"],"チィ":["tyi","cyi"],"チュ":["tyu","chu","cyu"],"チェ":["tye","che","cye"],"チョ":["tyo","cho","cyo"],"ニャ":["nya"],"ニィ":["nyi"],"ニュ":["nyu"],"ニェ":["nye"],"ニョ":["nyo"],"ヒャ":["hya"],"ヒィ":["hyi"],"ヒュ":["hyu"],"ヒェ":["hye"],"ヒョ":["hyo"],"ミャ":["mya"],"ミィ":["myi"],"ミュ":["myu"],"ミェ":["mye"],"ミョ":["myo"],"リャ":["rya"],"リィ":["ryi"],"リュ":["ryu"],"リェ":["rye"],"リョ":["ryo"],"ギャ":["gya"],"ギィ":["gyi"],"ギュ":["gyu"],"ギェ":["gye"],"ギョ":["gyo"],"ジャ":["ja","jya","zya"],"ジィ":["jyi","zyi"],"ジュ":["ju","jyu","zyu"],"ジェ":["je","jye","zye"],"ジョ":["jo","jyo","zyo"],"ビャ":["bya"],"ビィ":["byi"],"ビュ":["byu"],"ビェ":["bye"],"ビョ":["byo"],"ピャ":["pya"],"ピィ":["pyi"],"ピュ":["pyu"],"ピェ":["pye"],"ピョ":["pyo"],"イェ":["ye"],"ウァ":["wha"],"ウィ":["whi","wi"],"ウェ":["whe","we"],"ウォ":["who"],"クァ":["qa","kwa"],"クィ":["qi"],"クェ":["qe"],"クォ":["qo"],"ツァ":["tsa"],"ツィ":["tsi"],"ツェ":["tse"],"ツォ":["tso"],"テャ":["tha"],"ティ":["thi"],"テュ":["thu"],"テェ":["the"],"テョ":["tho"],"トァ":["twa"],"トィ":["twi"],"トゥ":["twu"],"トェ":["twe"],"トォ":["two"],"ファ":["fa"],"フィ":["fi"],"フェ":["fe"],"フォ":["fo"],"フャ":["fya"],"フュ":["fyu"],"フョ":["fyo"],"グァ":["gwa"],"グィ":["gwi"],"グゥ":["gwu"],"グェ":["gwe"],"グォ":["gwo"],"ヂャ":["dya"],"ヂィ":["dyi"],"ヂュ":["dyu"],"ヂェ":["dye"],"ヂョ":["dyo"],"デャ":["dha"],"ディ":["dhi"],"デュ":["dhu"],"デェ":["dhe"],"デョ":["dho"],"ドァ":["dwa"],"ドィ":["dwi"],"ドゥ":["dwu"],"ドェ":["dwe"],"ドォ":["dwo"],"ヴァ":["va"],"ヴィ":["vi","vyi"],"ヴェ":["ve","vye"],"ヴォ":["vo"],"ヴャ":["vya"],"ヴュ":["vyu"],"ヴョ":["vyo"]}),Kana.mapping=Object.assign({},Kana.DEFAULT_KANA_MAPPING),module.exports={Sentence:Sentence,KanaIterator:KanaIterator,Kana:Kana,Challenge:Challenge};